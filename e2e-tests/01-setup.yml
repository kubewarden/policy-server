name: Policy Server end-to-end setup
vars:
  pidfile: /tmp/policy-server.pid

testcases:
- name: Build policy-server binary with release mode. Can take quite some time...
  steps:
  - script: cargo build --release
    type: exec

- name: Start policy-server
  steps:
  - script: |
      cargo run --release -- \
        --ignore-kubernetes-connection-failure 1 \
        --policies test_data/policies.yaml \
        --policies-download-dir `pwd`/e2e-tests-policies \
        --policy-timeout 2 \
        --workers 1 \
        --daemon true \
        --daemon-stdout-file policy-server.out \
        --daemon-stderr-file policy-server.err \
        --daemon-pid-file {{ .pidfile }}
    type: exec

- name: Wait for policy-server to be ready
  steps:
  - type: http
    method: GET
    url: http://localhost:3000/readiness
    retry: 20
    delay: 5
    assertions:
    - result.statuscode ShouldEqual 200
  - script: |
      echo "policy-server is ready"

