name: Policy Server end-to-end tests

testcases:

- name: fixtures
  steps:
  - type: readfile
    path: ./test_data/pod_sleep_100ms.json
    assertions:
    - result.err ShouldBeEmpty
    vars:
      pod_sleep_100_ms:
        from: result.content
  - type: readfile
    path: ./test_data/pod_sleep_4s.json
    assertions:
    - result.err ShouldBeEmpty
    vars:
      pod_sleep_4s:
        from: result.content

- name: Accept a request that has a short evaluation time
  steps:
    - type: http
      method: POST
      url: http://localhost:3000/validate/sleep
      headers:
        Content-Type: application/json
      body: "{{ .fixtures.pod_sleep_100_ms }}"
      timeout: 3
      assertions:
      - result.statuscode ShouldEqual 200
      - result.bodyjson.response.allowed ShouldEqual true
      - result.timeseconds ShouldBeLessThan 2

- name: Interrupt and reject a request that has a long evaluation time
  steps:
    - type: http
      method: POST
      url: http://localhost:3000/validate/sleep
      headers:
        Content-Type: application/json
      body: "{{ .fixtures.pod_sleep_4s }}"
      timeout: 6
      assertions:
      - result.statuscode ShouldEqual 200
      - result.bodyjson.response.allowed ShouldEqual false
      - result.timeseconds ShouldBeLessThan 3

- name: Accept AGAIN a request that has a short evaluation time
  steps:
    - type: http
      method: POST
      url: http://localhost:3000/validate/sleep
      headers:
        Content-Type: application/json
      body: "{{ .fixtures.pod_sleep_100_ms }}"
      timeout: 3
      assertions:
      - result.statuscode ShouldEqual 200
      - result.bodyjson.response.allowed ShouldEqual true
      - result.timeseconds ShouldBeLessThan 2


